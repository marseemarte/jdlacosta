<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ver Sorteo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    <style>
        body { background-color: #f5f5f5; }
        .container-sorteo { margin-top: 30px; max-width: 1000px; }
        .section { background: white; padding: 20px; border-radius: 5px; margin-bottom: 30px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .select-school { margin-bottom: 20px; }
    </style>
</head>
<body>
<nav class="navbar navbar-dark bg-dark">
    <div class="container-fluid">
        <span class="navbar-brand"><i class="fas fa-dice"></i> Ver Orden de Sorteo</span>
        <a href="dashboard_jefatura.php" class="btn btn-outline-light btn-sm">Volver</a>
    </div>
</nav>

<div class="container-sorteo">
    <div class="section">
        <h5>Seleccionar Escuela Secundaria</h5>
        <div class="row select-school">
            <div class="col-md-8">
                <select id="selectEscuela" class="form-select">
                    <option value="">-- Seleccionar --</option>
                </select>
            </div>
            <div class="col-md-4">
                <button class="btn btn-primary" onclick="cargarSorteo()">Ver Sorteo</button>
            </div>
        </div>
    </div>

    <div class="section" id="seccionSorteo" style="display:none;">
        <h5 id="tituloEscuela"></h5>
        <table id="tablaSorteo" class="table table-striped">
            <thead>
                <tr>
                    <th>Orden</th>
                    <th>Apellido</th>
                    <th>Nombre</th>
                    <th>DNI</th>
                    <th>Vínculo</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
let tabla;
let vinculosMap = {};

// Cargar escuelas
function cargarEscuelas() {
    $.ajax({
        url: 'api/get_escuelas.php',
        method: 'GET',
        dataType: 'json',
        success: function(response) {
            if (response.success) {
                let html = '<option value="">-- Seleccionar --</option>';
                response.data.forEach(e => {
                    html += `<option value="${e.id}">${e.nombre}</option>`;
                });
                $('#selectEscuela').html(html);
            }
        }
    });
}

// Cargar vínculos para mapeo
function cargarVinculos() {
    $.ajax({
        url: 'api/get_vinculos.php',
        method: 'GET',
        dataType: 'json',
        success: function(response) {
            if (response.success) {
                response.data.forEach(v => {
                    vinculosMap[v.id] = v.vinculo;
                });
            }
        }
    });
}

function cargarSorteo() {
    const escuelaId = $('#selectEscuela').val();
    
    if (!escuelaId) {
        alert('Seleccione una escuela');
        return;
    }
    
    $.ajax({
        url: 'api/get_sorteo.php',
        method: 'GET',
        data: { id_secundaria: escuelaId },
        dataType: 'json',
        success: function(response) {
            if (response.success) {
                const escuelaNombre = $('#selectEscuela option:selected').text();
                $('#tituloEscuela').text('Sorteo: ' + escuelaNombre);
                
                let html = '';
                response.data.forEach((a, i) => {
                    const vinculo = vinculosMap[a.vinculo] || 'N/A';
                    html += `<tr>
                        <td>${i + 1}</td>
                        <td>${a.apellido}</td>
                        <td>${a.nombre}</td>
                        <td>${a.dni}</td>
                        <td>${vinculo}</td>
                    </tr>`;
                });
                
                $('#tablaSorteo tbody').html(html);
                $('#seccionSorteo').show();
                
                if (tabla) tabla.destroy();
                tabla = $('#tablaSorteo').DataTable({
                    pageLength: 25,
                    language: {
                        search: "Buscar:",
                        lengthMenu: "Mostrar _MENU_ entradas",
                        info: "Mostrando _START_ a _END_ de _TOTAL_",
                        paginate: { previous: "Anterior", next: "Siguiente" }
                    }
                });
            }
        }
    });
}

$(document).ready(function() {
    cargarEscuelas();
    cargarVinculos();
});
</script>
</body>
</html>
